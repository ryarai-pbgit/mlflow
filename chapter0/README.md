# 0. ネタ出し

## ストーリー

### 1.1 背景
直近はLLMの流行もあり、データ民主化（SQLやPythonが使えない人でも自然言語を介して社内のデータを活用できるようにする）の要請が強い。<br>
データの民主化の障壁になるのは、業務語を話してもその内容を反映したSQLを発行できない問題である。<br>
下流の方から見ていくと、例えばSnowflakeではセマンティックモデルを定義し、AIにデータ構造を伝えることで実現する流れができている。（Cortex Analyst機能）<br>
セマンティックモデルを作り内容を把握している（データ）エンジニアは、暗黙の延髄反射や脳内変換で業務語をIT語に変換できるため、いとも簡単に使いこなせる。<br>
一方で、民主化の本来の目的である非エンジニア層のお客様は、愚直に業務語でCortex Analystを直撃するため、うまくいかない。<br>
この状況を打破するために、実プロジェクトにおいては、辞書、RAG、SLMの活用など様々な取り組みが行われている。

### 1.2 問題設定までの検討過程
今回のプロジェクト課題に際して、研修で学んだ技術をもとに、この問題にアクセスできないかを検討した。<br>
具体的には、研修で学んだ(今や比較的古典的なモデルと言われるようになった)BERTをうまく活用できないかと考えた。<br>
語彙変換を扱おうとすると、自身の力不足もあり、評価方法など含めて現実的な時間で解決できる気がしなかった。<br>
一方で、業務語を話すユーザが自分の問いかけがうまくSQL変換できているか否か、の２クラス分類であればできるのではないかと考えた。<br>
うまく変換されない問いかけであれば、その旨通知して、質問文を変更してもらう、最初は手間だが、慣れてくれば、ほど良いチェック機構として実用化の可能性もあるのではないかと考えた。<br>
では、うまくSQL変換できている、とは何か？<br>
下流の仕組みから考えると、SnowflakeのCortex Analystには検証済みクエリという機能がある。<br>
これは、事前に有益であることが判明している質問文とSQLのペアをCortex Analystに登録しておき、その上で自然言語での問い合わせに対して、登録されている質問文と類似しているCortex AnalystのAIに判定された場合、検証済みのSQLをもとにクエリが生成される仕組みである。<br>
検証済みのSQLを元にしたSQLが発行されるということは、無限のありとあらゆるSQLが発行される可能性を秘める自然言語クエリの世界において、確かなSQLが発行され得られた結果が保証される、ことを意味する。<br>
つまり、この検証済みクエリにヒットさせるような業務語を発することは、うまくSQL変換できている、と言えると考えた。<br>

### 1.3 問題設定
下記のように設定することにした。
- 問題設定：自然言語でのデータ分析問い合わせが、Snowflake Cortex Analystで検証済みと判定される質問になっているか、否かの２クラス分類問題
- 事前準備：Snowflakeに検証用データベース＆データとCortex Analystの検証済みクエリを設定
- データ：任意の自然言語問い合わせ（これは自作）をCortex Analystに１度通して、検証済みの問いかけか否か（検証済みクエリと判定された：1,されない：0）
- モデル：研修で利用したBERT
- 評価方法：研修のノートブックに書いてあるやつ


### 2.1 セマンティックモデルの検証済みクエリ
今回のSnowflake上のデータセットは以前にも別の分析系案件で利用したものであるため、これまでの実績も踏まえてSnowflake側から提案されていた下記の３件を検証済みクエリとした。

- 1件目：延滞しているユーザーの属性（年齢、収入、職業など）とクレジットカード決済による取引カテゴリーの関係性を分析したい
[src/1.sql](src/1.sql) 

- 一番取引が多いユーザは誰で、どのような取引をしていますか？
[src/2.sql](src/2.sql) 

- 3件目：以下のRAGコンテキストを参考に、質問に答えてください。
        RAGコンテキスト:
        旅行の平均支出が少ない人は、年収に関係なく手持ちに余裕がなく、クレジットカード延滞が多くなる傾向がある。
        質問: クレジットカードの延滞がある人とない人の特徴を分析したい
        上記のRAGコンテキストを基に、詳細で有用な回答を提供してください。
[src/3.sql](src/3.sql) 

最終的なセマンティックモデルはこちら<br>
[src/model.yaml](src/model.yaml) 




